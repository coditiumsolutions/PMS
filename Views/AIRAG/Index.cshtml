@{
    ViewData["Title"] = "AI RAG - Database Assistant";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>AI Database Assistant</h2>
                <button class="btn btn-secondary" onclick="clearChat()">
                    <i class="bi bi-trash"></i> Clear Chat
                </button>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div id="chatMessages" class="chat-container mb-3" style="height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1.25rem; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);">
                        <div class="chat-message assistant-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                    AI
                                </div>
                                <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                    <p class="mb-2">Hello! I'm your AI database assistant. I can help you query the Property Management System database.</p>
                                    <p class="mb-2 fw-semibold">Click on any question below to try it:</p>
                                    <div class="example-questions mt-2">
                                        <button class="btn btn-outline-primary btn-sm mb-2 me-2 example-question-btn" onclick="fillQuestion('Show me report of new customers are created each month')">
                                            <i class="bi bi-question-circle me-1"></i> Q1: Show me report of new customers are created each month
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm mb-2 me-2 example-question-btn" onclick="fillQuestion('Show me new Payment created this month group by bank name?')">
                                            <i class="bi bi-question-circle me-1"></i> Q2: Show me new Payment created this month group by bank name?
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm mb-2 me-2 example-question-btn" onclick="fillQuestion('Show me all customers with nic number 35201-3596997-3')">
                                            <i class="bi bi-question-circle me-1"></i> Q3: Show me all customers with nic number 35201-3596997-3
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted ms-5">Just now</small>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="Ask a question about the database..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()" id="sendButton">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-container {
        scroll-behavior: smooth;
    }

    .chat-message {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .user-message {
        flex-direction: row-reverse;
    }

    .user-message .message-content {
        background: linear-gradient(135deg, #0056b3 0%, #007bff 100%);
        color: #ffffff !important;
        margin-left: auto;
        margin-right: 0;
        border: 1px solid #0056b3;
    }

    .user-message .message-content * {
        color: #ffffff !important;
    }

    .user-message .message-content p,
    .user-message .message-content strong,
    .user-message .message-content span,
    .user-message .message-content div {
        color: #ffffff !important;
    }

    .assistant-message .message-content {
        background-color: #ffffff;
        color: #212529;
        border: 1px solid #e9ecef;
    }

    .message-content {
        word-wrap: break-word;
        line-height: 1.6;
        overflow-x: hidden;
        max-width: 100%;
        min-width: 0;
        box-sizing: border-box;
    }
    
    /* Ensure table containers don't break layout */
    .message-content .card-body,
    .message-content .tab-content,
    .message-content .tab-pane {
        overflow-x: hidden;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    .message-content .tab-pane.active {
        overflow-x: visible;
    }

    .message-content p {
        margin-bottom: 0.5rem;
    }

    .message-content p:last-child {
        margin-bottom: 0;
    }

    .query-result-table {
        margin-top: 10px;
        font-size: 0.875rem;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
        min-width: 0;
        display: block;
    }

    .query-result-table .table-responsive {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 400px;
        box-sizing: border-box;
        display: block;
        -webkit-overflow-scrolling: touch;
    }

    .query-result-table table {
        width: 100%;
        min-width: 600px;
        border-collapse: collapse;
        margin-bottom: 0;
        table-layout: auto;
        display: table;
    }

    .query-result-table th,
    .query-result-table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: left;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .query-result-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .query-result-table .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .query-result-table .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .query-result-table {
            font-size: 0.8rem;
        }

        .query-result-table th,
        .query-result-table td {
            padding: 6px 8px;
        }
    }

    @@media (max-width: 576px) {
        .query-result-table {
            font-size: 0.75rem;
        }

        .query-result-table th,
        .query-result-table td {
            padding: 4px 6px;
        }
    }

    .sql-query-display {
        background-color: #f1f3f5;
        border-left: 3px solid #007bff;
        padding: 8px;
        margin-top: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        border-radius: 4px;
    }

    .user-msg .sql-query-display {
        background-color: rgba(255, 255, 255, 0.15);
        border-left-color: #ffffff;
        color: #ffffff !important;
    }

    .user-msg .sql-query-display code {
        color: #ffffff !important;
    }

    .user-msg .sql-query-display strong {
        color: #ffffff !important;
    }

    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .query-result-collapsible {
        margin-top: 10px;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }
    
    .query-result-collapsible .card {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
    }
    
    .query-result-collapsible .card-body {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
        padding: 0;
    }

    .user-msg .query-result-collapsible button {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
        color: #ffffff !important;
    }

    .user-msg .query-result-collapsible button:hover {
        background-color: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: #ffffff !important;
    }

    .user-msg .query-result-collapsible button strong {
        color: #ffffff !important;
    }

    .query-result-collapsible button {
        font-size: 0.875rem;
    }

    .query-result-collapsible .collapse-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }

    .query-result-collapsible button[aria-expanded="true"] .collapse-icon {
        transform: rotate(180deg);
    }

    .query-result-collapsible .card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .query-result-collapsible .table {
        margin-bottom: 0;
    }

    .example-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .example-question-btn {
        text-align: left;
        white-space: normal;
        word-wrap: break-word;
        max-width: 100%;
        transition: all 0.2s ease;
    }

    .example-question-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
    }

    .example-question-btn:active {
        transform: translateY(0);
    }

    @@media (max-width: 768px) {
        .example-questions {
            flex-direction: column;
        }

        .example-question-btn {
            width: 100%;
            margin-right: 0 !important;
        }
    }

    .visualization-tabs {
        margin-top: 10px;
    }

    .visualization-tabs .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }

    .visualization-tabs .nav-link {
        color: #495057;
        border: none;
        border-bottom: 2px solid transparent;
        padding: 0.5rem 1rem;
    }

    .visualization-tabs .nav-link:hover {
        border-color: #dee2e6;
    }

    .visualization-tabs .nav-link.active {
        color: #007bff;
        background-color: transparent;
        border-color: #007bff;
        font-weight: 600;
    }

    .visualization-tabs .tab-content {
        padding: 1rem 0;
        min-height: 300px;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
    }
    
    .visualization-tabs {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }
    
    .visualization-tabs .tab-pane {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
        display: none; /* Hide by default */
    }
    
    .visualization-tabs .tab-pane.show,
    .visualization-tabs .tab-pane.active {
        display: block; /* Show when active */
        overflow-x: visible;
    }
    
    .visualization-tabs .tab-pane.show.active {
        display: block !important; /* Ensure active tab is visible */
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }

    .user-msg .visualization-tabs .nav-link {
        color: rgba(255, 255, 255, 0.8);
    }

    .user-msg .visualization-tabs .nav-link:hover {
        color: #ffffff;
        border-color: rgba(255, 255, 255, 0.5);
    }

    .user-msg .visualization-tabs .nav-link.active {
        color: #ffffff;
        border-color: #ffffff;
    }

    .user-msg .tab-content {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 0.375rem;
        padding: 1rem;
    }

    /* Responsive adjustments for chat container */
    @@media (max-width: 768px) {
        .chat-container {
            padding: 0.75rem !important;
        }

        .message-content {
            max-width: 100% !important;
            padding: 0.75rem !important;
        }

        .visualization-tabs .nav-link {
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
        }

        .chart-container {
            height: 250px;
        }
    }

    @@media (max-width: 576px) {
        .chat-container {
            padding: 0.5rem !important;
        }

        .message-content {
            padding: 0.5rem !important;
            font-size: 0.875rem;
        }

        .visualization-tabs .nav-link {
            padding: 0.35rem 0.5rem;
            font-size: 0.8rem;
        }

        .visualization-tabs .nav-link i {
            font-size: 0.9rem;
        }

        .chart-container {
            height: 200px;
        }

        .query-result-table .table-responsive {
            max-height: 300px;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        .query-result-table table {
            min-width: 500px;
        }
    }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    let conversationHistory = [];

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;

        // Disable input and button
        input.disabled = true;
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;
        sendButton.innerHTML = '<span class="loading-spinner"></span> Sending...';

        // Add user message to chat
        addMessageToChat('user', message);
        input.value = '';

        try {
            const response = await fetch('/AIRAG/Chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversationHistory: conversationHistory
                })
            });

            const data = await response.json();

            if (data.success) {
                addMessageToChat('assistant', data.message.content, data.message.queryResult);
                // Update conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
                conversationHistory.push({
                    role: 'assistant',
                    content: data.message.content
                });
            } else {
                addMessageToChat('assistant', `Error: ${data.error || 'Unknown error occurred'}`);
            }
        } catch (error) {
            addMessageToChat('assistant', `Error: ${error.message}`);
        } finally {
            // Re-enable input and button
            input.disabled = false;
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="bi bi-send"></i> Send';
            input.focus();
        }
    }

    function addMessageToChat(role, content, queryResult = null) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message mb-3`;

        const avatarBg = role === 'user' ? 'bg-primary' : 'bg-success';
        const avatarText = role === 'user' ? 'You' : 'AI';
        const isUser = role === 'user';

        let messageHtml = `
            <div class="d-flex align-items-start ${isUser ? 'justify-content-end' : ''}">
                ${!isUser ? `<div class="avatar ${avatarBg} text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px; font-size: 0.875rem; flex-shrink: 0;">
                    ${avatarText}
                </div>` : ''}
                <div class="message-content ${isUser ? 'user-msg' : 'assistant-msg'} p-3 rounded shadow-sm" style="max-width: min(75%, 100%); width: 100%; box-sizing: border-box;">
                    <p class="mb-0" style="color: ${isUser ? '#ffffff' : '#212529'}; font-weight: ${isUser ? '500' : '400'};">
                        ${escapeHtml(content)}
                    </p>
        `;

        if (queryResult) {
            if (queryResult.generatedQuery) {
                messageHtml += `
                    <div class="sql-query-display mt-2">
                        <strong>Generated SQL:</strong><br>
                        <code>${escapeHtml(queryResult.generatedQuery)}</code>
                    </div>
                `;
            }

            if (queryResult.success && queryResult.rows && queryResult.rows.length > 0) {
                const resultId = 'result-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const tabId = 'tab-' + resultId;
                const tableTabId = 'table-' + resultId;
                const graphTabId = 'graph-' + resultId;
                const chartTabId = 'chart-' + resultId;
                
                // Store queryResult data as JSON for chart initialization
                const queryResultJson = JSON.stringify(queryResult);
                
                messageHtml += `
                    <div class="query-result-collapsible mt-3">
                        <button class="btn btn-sm btn-outline-secondary w-100 text-start d-flex align-items-center justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#${resultId}" aria-expanded="false" aria-controls="${resultId}">
                            <span><i class="bi bi-chevron-down me-2 collapse-icon"></i><strong>View Query Results</strong> (${queryResult.rows.length} row${queryResult.rows.length !== 1 ? 's' : ''})</span>
                        </button>
                        <div class="collapse mt-2" id="${resultId}" data-query-result='${escapeHtml(queryResultJson)}'>
                            <div class="card card-body p-0">
                                <div class="visualization-tabs">
                                    <ul class="nav nav-tabs" id="${tabId}" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="${tableTabId}-tab" data-bs-toggle="tab" data-bs-target="#${tableTabId}" type="button" role="tab" aria-controls="${tableTabId}" aria-selected="true">
                                                <i class="bi bi-table"></i> Table
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="${graphTabId}-tab" data-bs-toggle="tab" data-bs-target="#${graphTabId}" type="button" role="tab" aria-controls="${graphTabId}" aria-selected="false">
                                                <i class="bi bi-bar-chart"></i> Graph
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="${chartTabId}-tab" data-bs-toggle="tab" data-bs-target="#${chartTabId}" type="button" role="tab" aria-controls="${chartTabId}" aria-selected="false">
                                                <i class="bi bi-pie-chart"></i> Chart
                                            </button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="${tabId}Content">
                                        <!-- Table Tab -->
                                        <div class="tab-pane fade show active" id="${tableTabId}" role="tabpanel" aria-labelledby="${tableTabId}-tab">
                                            <div class="query-result-table p-2">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered table-striped table-hover mb-0">
                `;
                
                // Header
                messageHtml += '<thead class="table-light sticky-top"><tr>';
                queryResult.columns.forEach(col => {
                    messageHtml += `<th style="white-space: nowrap;">${escapeHtml(col)}</th>`;
                });
                messageHtml += '</tr></thead>';
                
                // Rows
                messageHtml += '<tbody>';
                queryResult.rows.forEach(row => {
                    messageHtml += '<tr>';
                    queryResult.columns.forEach(col => {
                        const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
                        messageHtml += `<td style="white-space: nowrap;">${escapeHtml(String(value))}</td>`;
                    });
                    messageHtml += '</tr>';
                });
                messageHtml += '</tbody>';
                
                messageHtml += `
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Graph Tab -->
                                        <div class="tab-pane fade" id="${graphTabId}" role="tabpanel" aria-labelledby="${graphTabId}-tab">
                                            <div class="chart-container">
                                                <canvas id="graph-${resultId}"></canvas>
                                            </div>
                                        </div>
                                        <!-- Chart Tab -->
                                        <div class="tab-pane fade" id="${chartTabId}" role="tabpanel" aria-labelledby="${chartTabId}-tab">
                                            <div class="chart-container">
                                                <canvas id="chart-${resultId}"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (queryResult.error) {
                messageHtml += `<div class="alert alert-danger mt-2 mb-0">${escapeHtml(queryResult.error)}</div>`;
            }
        }

        messageHtml += `
                </div>
                ${isUser ? `<div class="avatar ${avatarBg} text-white rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 36px; height: 36px; font-size: 0.875rem; flex-shrink: 0;">
                    ${avatarText}
                </div>` : ''}
            </div>
            <small class="text-muted ${isUser ? 'text-end me-5' : 'ms-5'}" style="display: block; margin-top: 4px;">${new Date().toLocaleTimeString()}</small>
        `;

        messageDiv.innerHTML = messageHtml;
        chatMessages.appendChild(messageDiv);
        
        // Initialize Bootstrap collapse and charts for the new collapsible section
        if (queryResult && queryResult.success && queryResult.rows && queryResult.rows.length > 0) {
            // Wait for Bootstrap to be available
            setTimeout(() => {
                if (typeof bootstrap !== 'undefined') {
                    const collapseElement = messageDiv.querySelector('.collapse');
                    const toggleButton = messageDiv.querySelector('[data-bs-toggle="collapse"]');
                    
                    if (collapseElement && toggleButton) {
                        // Store queryResult in the collapse element for later access
                        collapseElement._queryResult = queryResult;
                        
                        // Update icon rotation on collapse events
                        collapseElement.addEventListener('show.bs.collapse', function() {
                            const icon = toggleButton.querySelector('.collapse-icon');
                            if (icon) icon.style.transform = 'rotate(180deg)';
                            toggleButton.setAttribute('aria-expanded', 'true');
                            
                            // Initialize charts when expanded (with small delay to ensure DOM is ready)
                            // Only initialize for the active tab (Table tab is active by default)
                            setTimeout(() => {
                                const storedQueryResult = collapseElement._queryResult || queryResult;
                                // Don't initialize charts on collapse show - wait for tab click
                                // Charts will be initialized when user clicks on Graph or Chart tabs
                            }, 200);
                        });
                        
                        collapseElement.addEventListener('hide.bs.collapse', function() {
                            const icon = toggleButton.querySelector('.collapse-icon');
                            if (icon) icon.style.transform = 'rotate(0deg)';
                            toggleButton.setAttribute('aria-expanded', 'false');
                        });
                    }
                    
                    // Initialize charts when tabs are shown
                    const tabButtons = messageDiv.querySelectorAll('[data-bs-toggle="tab"]');
                    tabButtons.forEach(button => {
                        button.addEventListener('shown.bs.tab', function(e) {
                            // e.target is the button that was clicked
                            // e.relatedTarget is the previously active button
                            const targetId = e.target.getAttribute('data-bs-target') || 
                                          (e.target.closest('[data-bs-target]')?.getAttribute('data-bs-target'));
                            const targetTab = targetId && targetId.includes('graph') ? 'graph' : 
                                             targetId && targetId.includes('chart') ? 'chart' : null;
                            
                            // Wait a bit to ensure tab transition is complete
                            // Bootstrap's 'shown.bs.tab' event fires after transition, but we need extra time
                            setTimeout(async () => {
                                const collapseEl = messageDiv.querySelector('.collapse');
                                const storedQueryResult = collapseEl?._queryResult || queryResult;
                                if (targetTab) {
                                    // Bootstrap should have already shown the target tab, but ensure others are hidden
                                    const targetPane = messageDiv.querySelector(targetId);
                                    if (targetPane) {
                                        const tabContent = targetPane.closest('.tab-content');
                                        if (tabContent) {
                                            // Hide all other tab panes (Bootstrap should handle this, but ensure it)
                                            const allTabPanes = tabContent.querySelectorAll('.tab-pane');
                                            allTabPanes.forEach(pane => {
                                                if (pane !== targetPane) {
                                                    pane.classList.remove('show', 'active');
                                                    // Remove inline display style to let CSS handle it
                                                    pane.style.display = '';
                                                }
                                            });
                                            // Ensure target is visible (Bootstrap way)
                                            targetPane.classList.add('show', 'active');
                                            // Remove inline display style to let CSS handle it
                                            targetPane.style.display = '';
                                        }
                                        // Wait a bit more for Bootstrap to complete the transition
                                        await new Promise(resolve => setTimeout(resolve, 100));
                                    }
                                    initializeCharts(storedQueryResult, messageDiv, targetTab);
                                }
                            }, 200); // Delay to ensure tab is fully shown
                        });
                    });
                }
            }, 100);
        }
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function clearChat() {
        if (confirm('Are you sure you want to clear the chat history?')) {
            conversationHistory = [];
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="chat-message assistant-message mb-3">
                    <div class="d-flex align-items-start">
                        <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.875rem;">
                            AI
                        </div>
                        <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                            <p class="mb-2">Chat cleared. How can I help you today?</p>
                            <p class="mb-2 fw-semibold">Click on any question below to try it:</p>
                            <div class="example-questions mt-2">
                                <button class="btn btn-outline-primary btn-sm mb-2 me-2 example-question-btn" onclick="fillQuestion('Show me new customers are created this month?')">
                                    <i class="bi bi-question-circle me-1"></i> Q1: Show me new customers are created this month?
                                </button>
                                <button class="btn btn-outline-primary btn-sm mb-2 me-2 example-question-btn" onclick="fillQuestion('Show me new Payment created this month group by Subproject?')">
                                    <i class="bi bi-question-circle me-1"></i> Q2: Show me new Payment created this month group by Subproject?
                                </button>
                                <button class="btn btn-outline-primary btn-sm mb-2 me-2 example-question-btn" onclick="fillQuestion('Show me all customers with nic number 35201-3596997-3')">
                                    <i class="bi bi-question-circle me-1"></i> Q3: Show me all customers with nic number 35201-3596997-3
                                </button>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted ms-5">Just now</small>
                </div>
            `;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function fillQuestion(question) {
        const input = document.getElementById('chatInput');
        if (input) {
            input.value = question;
            input.focus();
            // Scroll input into view if needed
            input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function isNumeric(value) {
        if (value === null || value === undefined || value === '') return false;
        return !isNaN(value) && !isNaN(parseFloat(value));
    }

    function detectNumericColumns(columns, rows) {
        const numericColumns = [];
        const categoricalColumns = [];
        
        columns.forEach(col => {
            let hasNumeric = false;
            let hasNonNumeric = false;
            
            rows.forEach(row => {
                const value = row[col];
                if (value !== null && value !== undefined && value !== '') {
                    if (isNumeric(value)) {
                        hasNumeric = true;
                    } else {
                        hasNonNumeric = true;
                    }
                }
            });
            
            if (hasNumeric && !hasNonNumeric) {
                numericColumns.push(col);
            } else {
                categoricalColumns.push(col);
            }
        });
        
        return { numericColumns, categoricalColumns };
    }

    async function initializeCharts(queryResult, messageDiv, targetTab = null) {
        if (!queryResult || !queryResult.rows || queryResult.rows.length === 0) return;
        if (typeof Chart === 'undefined') return; // Chart.js not loaded yet
        
        const { numericColumns, categoricalColumns } = detectNumericColumns(queryResult.columns, queryResult.rows);
        
        // Find the result ID from the collapse element
        const collapseElement = messageDiv.querySelector('.collapse');
        if (!collapseElement) return;
        
        const resultId = collapseElement.id;
        // #region agent log
        fetch('http://127.0.0.1:7243/ingest/8d743264-53ef-4c21-b9f1-07472dc473cf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'AIRAG:848',message:'resultId found',data:{resultId:resultId,hasId:!!resultId,idType:typeof resultId},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'B'})}).catch(()=>{});
        // #endregion
        
        // Find tab panes first, then find canvas elements inside them
        // This avoids ID conflicts (tab pane and canvas both have similar IDs)
        const graphTabPane = messageDiv.querySelector(`#graph-${resultId}.tab-pane`);
        const chartTabPane = messageDiv.querySelector(`#chart-${resultId}.tab-pane`);
        
        // Find canvas elements inside the tab panes
        const graphCanvas = graphTabPane ? graphTabPane.querySelector('canvas') : null;
        const chartCanvas = chartTabPane ? chartTabPane.querySelector('canvas') : null;
        
        // #region agent log
        fetch('http://127.0.0.1:7243/ingest/8d743264-53ef-4c21-b9f1-07472dc473cf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'AIRAG:851',message:'canvas elements found',data:{graphCanvas:graphCanvas?{tagName:graphCanvas.tagName,nodeName:graphCanvas.nodeName,constructor:graphCanvas.constructor.name,hasGetContext:typeof graphCanvas.getContext,id:graphCanvas.id,isCanvas:graphCanvas instanceof HTMLCanvasElement}:null,chartCanvas:chartCanvas?{tagName:chartCanvas.tagName,nodeName:chartCanvas.nodeName,constructor:chartCanvas.constructor.name,hasGetContext:typeof chartCanvas.getContext,id:chartCanvas.id,isCanvas:chartCanvas instanceof HTMLCanvasElement}:null,graphTabPane:graphTabPane?{id:graphTabPane.id}:null,chartTabPane:chartTabPane?{id:chartTabPane.id}:null},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        
        if (!graphCanvas || !chartCanvas) return; // Canvas elements not found
        
        // Helper function to check if tab pane is visible
        const isTabPaneVisible = (tabPane) => {
            if (!tabPane) return true; // If no tab pane, assume visible
            return tabPane.classList.contains('show') && tabPane.classList.contains('active');
        };
        
        // Helper function to ensure canvas is ready for Chart.js
        const ensureCanvasReady = async (canvas, tabPane) => {
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/8d743264-53ef-4c21-b9f1-07472dc473cf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'AIRAG:865',message:'ensureCanvasReady entry',data:{canvas:canvas?{tagName:canvas.tagName,nodeName:canvas.nodeName,constructor:canvas.constructor.name,hasGetContext:typeof canvas.getContext,id:canvas.id,type:typeof canvas,isCanvas:canvas instanceof HTMLCanvasElement}:null,tabPane:tabPane?{id:tabPane.id,className:tabPane.className}:null},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            if (!canvas) return false;
            
            // Verify it's actually a canvas element
            if (!(canvas instanceof HTMLCanvasElement)) {
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/8d743264-53ef-4c21-b9f1-07472dc473cf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'AIRAG:870',message:'canvas is not HTMLCanvasElement',data:{canvas:canvas?{tagName:canvas.tagName,constructor:canvas.constructor.name}:null},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                return false;
            }
            
            // Ensure tab is visible - this is critical
            if (tabPane) {
                // Get all tab panes in the same tab-content to hide others
                const tabContent = tabPane.closest('.tab-content');
                if (tabContent) {
                    // Hide all other tab panes first (let Bootstrap handle visibility)
                    const allTabPanes = tabContent.querySelectorAll('.tab-pane');
                    allTabPanes.forEach(pane => {
                        if (pane !== tabPane) {
                            pane.classList.remove('show', 'active');
                            // Remove inline display style to let CSS handle it
                            pane.style.display = '';
                        }
                    });
                }
                
                // Make the target tab visible (Bootstrap way)
                tabPane.classList.remove('fade');
                tabPane.classList.add('show', 'active');
                // Remove inline display style to let CSS handle it
                tabPane.style.display = '';
                
                // Ensure parent tab-content is visible
                if (tabContent) {
                    tabContent.style.display = 'block';
                }
            }
            
            // Ensure canvas is in the DOM
            if (!canvas.parentElement) {
                console.warn('Canvas has no parent element');
                return false;
            }
            
            // Wait for DOM to update and ensure canvas is rendered
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Force a reflow to ensure canvas is rendered
            canvas.offsetHeight;
            
            // Try to get context - this is what Chart.js needs
            // If we can't get context, Chart.js won't be able to either
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/8d743264-53ef-4c21-b9f1-07472dc473cf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'AIRAG:898',message:'before getContext call',data:{canvas:canvas?{tagName:canvas.tagName,nodeName:canvas.nodeName,constructor:canvas.constructor.name,hasGetContext:typeof canvas.getContext,id:canvas.id,isCanvas:canvas instanceof HTMLCanvasElement}:null},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            try {
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    // Wait more and try again
                    await new Promise(resolve => setTimeout(resolve, 200));
                    const ctx2 = canvas.getContext('2d');
                    return ctx2 !== null;
                }
                return true;
            } catch (e) {
                console.warn('Failed to get canvas context:', e);
                // One more attempt after longer wait
                await new Promise(resolve => setTimeout(resolve, 300));
                try {
                    const ctx = canvas.getContext('2d');
                    return ctx !== null;
                } catch (e2) {
                    return false;
                }
            }
        };
        
        // Only initialize charts for the specific tab that was clicked
        // If targetTab is null, don't initialize any charts (they'll be initialized on tab click)
        const shouldInitGraph = targetTab === 'graph';
        const shouldInitChart = targetTab === 'chart';
        
        // Initialize Graph (Bar/Line Chart)
        if (graphCanvas && shouldInitGraph) {
            try {
                // Destroy existing chart if it exists
                const existingGraphChart = Chart.getChart(graphCanvas);
                if (existingGraphChart) {
                    existingGraphChart.destroy();
                }
                
                // Ensure canvas is ready before creating chart
                const isReady = await ensureCanvasReady(graphCanvas, graphTabPane);
                if (!isReady) {
                    console.warn('Graph canvas not ready, skipping chart initialization');
                } else {
                    // Determine best visualization
                    let chartType = 'bar';
                    let labels = [];
                    let datasets = [];
                    
                    if (categoricalColumns.length > 0 && numericColumns.length > 0) {
                        // Use first categorical column as labels, first numeric as values
                        const labelColumn = categoricalColumns[0];
                        const valueColumn = numericColumns[0];
                        
                        labels = queryResult.rows.map(row => String(row[labelColumn] || ''));
                        const values = queryResult.rows.map(row => {
                            const val = row[valueColumn];
                            return isNumeric(val) ? parseFloat(val) : 0;
                        });
                        
                        datasets = [{
                            label: valueColumn,
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }];
                    } else if (numericColumns.length >= 2) {
                        // Use first numeric column as labels, second as values
                        const labelColumn = numericColumns[0];
                        const valueColumn = numericColumns[1];
                        
                        labels = queryResult.rows.map(row => String(row[labelColumn] || ''));
                        const values = queryResult.rows.map(row => {
                            const val = row[valueColumn];
                            return isNumeric(val) ? parseFloat(val) : 0;
                        });
                        
                        datasets = [{
                            label: valueColumn,
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }];
                    } else if (numericColumns.length === 1 && categoricalColumns.length > 0) {
                        // Use categorical as labels, numeric as values
                        const labelColumn = categoricalColumns[0];
                        const valueColumn = numericColumns[0];
                        
                        labels = queryResult.rows.map(row => String(row[labelColumn] || ''));
                        const values = queryResult.rows.map(row => {
                            const val = row[valueColumn];
                            return isNumeric(val) ? parseFloat(val) : 0;
                        });
                        
                        datasets = [{
                            label: valueColumn,
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }];
                    } else {
                        // Fallback: use row index as labels, count as values
                        labels = queryResult.rows.map((_, idx) => `Row ${idx + 1}`);
                        datasets = [{
                            label: 'Count',
                            data: new Array(queryResult.rows.length).fill(1),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }];
                    }
                    
                    // Create chart - Chart.js will handle context acquisition
                    try {
                        new Chart(graphCanvas, {
                            type: chartType,
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: datasets.length > 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Data Visualization'
                                    }
                                },
                                scales: chartType === 'bar' ? {
                                    y: {
                                        beginAtZero: true
                                    }
                                } : {}
                            }
                        });
                    } catch (chartError) {
                        console.error('Failed to create graph chart:', chartError);
                        // Try one more time after a delay
                        setTimeout(() => {
                            try {
                                new Chart(graphCanvas, {
                                    type: chartType,
                                    data: {
                                        labels: labels,
                                        datasets: datasets
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: datasets.length > 1
                                            },
                                            title: {
                                                display: true,
                                                text: 'Data Visualization'
                                            }
                                        },
                                        scales: chartType === 'bar' ? {
                                            y: {
                                                beginAtZero: true
                                            }
                                        } : {}
                                    }
                                });
                            } catch (retryError) {
                                console.error('Failed to create graph chart on retry:', retryError);
                            }
                        }, 500);
                    }
                } // End of else block for accessible canvas
            } catch (error) {
                console.error('Failed to initialize graph chart:', error);
            }
        }
        
        // Initialize Chart (Pie/Doughnut)
        if (chartCanvas && shouldInitChart) {
            try {
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(chartCanvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // Ensure canvas is ready before creating chart
                const isReady = await ensureCanvasReady(chartCanvas, chartTabPane);
                if (!isReady) {
                    console.warn('Chart canvas not ready, skipping chart initialization');
                } else {
                    // Initialize pie chart
                    let labels = [];
                    let values = [];
                    
                    if (categoricalColumns.length > 0 && numericColumns.length > 0) {
                        // Use categorical as labels, numeric as values
                        const labelColumn = categoricalColumns[0];
                        const valueColumn = numericColumns[0];
                        
                        labels = queryResult.rows.map(row => String(row[labelColumn] || ''));
                        values = queryResult.rows.map(row => {
                            const val = row[valueColumn];
                            return isNumeric(val) ? parseFloat(val) : 1;
                        });
                    } else if (categoricalColumns.length > 0) {
                        // Count occurrences of each category
                        const labelColumn = categoricalColumns[0];
                        const counts = {};
                        queryResult.rows.forEach(row => {
                            const label = String(row[labelColumn] || 'Unknown');
                            counts[label] = (counts[label] || 0) + 1;
                        });
                        
                        labels = Object.keys(counts);
                        values = Object.values(counts);
                    } else if (numericColumns.length > 0) {
                        // Use first numeric column as values, create labels
                        const valueColumn = numericColumns[0];
                        labels = queryResult.rows.map((_, idx) => `Item ${idx + 1}`);
                        values = queryResult.rows.map(row => {
                            const val = row[valueColumn];
                            return isNumeric(val) ? parseFloat(val) : 1;
                        });
                    } else {
                        // Fallback: equal distribution
                        labels = queryResult.rows.map((_, idx) => `Row ${idx + 1}`);
                        values = new Array(queryResult.rows.length).fill(1);
                    }
                    
                    // Generate colors
                    const colors = [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)',
                        'rgba(199, 199, 199, 0.6)',
                        'rgba(83, 102, 255, 0.6)',
                        'rgba(255, 99, 255, 0.6)',
                        'rgba(99, 255, 132, 0.6)'
                    ];
                    
                    const backgroundColors = [];
                    const borderColors = [];
                    for (let i = 0; i < labels.length; i++) {
                        const colorIndex = i % colors.length;
                        backgroundColors.push(colors[colorIndex]);
                        borderColors.push(colors[colorIndex].replace('0.6', '1'));
                    }
                    
                    // Create chart - Chart.js will handle context acquisition
                    try {
                        new Chart(chartCanvas, {
                            type: 'pie',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: values,
                                    backgroundColor: backgroundColors,
                                    borderColor: borderColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Data Distribution'
                                    }
                                }
                            }
                        });
                    } catch (chartError) {
                        console.error('Failed to create pie chart:', chartError);
                        // Try one more time after a delay
                        setTimeout(() => {
                            try {
                                new Chart(chartCanvas, {
                                    type: 'pie',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            data: values,
                                            backgroundColor: backgroundColors,
                                            borderColor: borderColors,
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                position: 'right'
                                            },
                                            title: {
                                                display: true,
                                                text: 'Data Distribution'
                                            }
                                        }
                                    }
                                });
                            } catch (retryError) {
                                console.error('Failed to create pie chart on retry:', retryError);
                            }
                        }, 500);
                    }
                } // End of else block for accessible canvas
            } catch (error) {
                console.error('Failed to initialize pie chart:', error);
            }
        }
    }
</script>
