@{
    ViewData["Title"] = "Customer Operations";
}

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h2>Customer Operations</h2>
    </div>

    <!-- Search Section -->
    <div class="card shadow-sm mb-2">
        <div class="card-body py-2">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" 
                               placeholder="Enter Customer ID, Name, or CNIC Number..." 
                               autocomplete="off" />
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <span id="searchBtnText">Search</span>
                            <span id="searchSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="d-none">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Search Results</h5>
            </div>
            <div class="card-body p-0">
                <div id="resultsTableContainer">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noResultsMessage" class="d-none">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="alert alert-warning mb-0 text-center">
                    <h5 class="mb-2">No Record Found</h5>
                    <p class="mb-0">No customer records match your search criteria. Please try a different search term.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchBtnText = document.getElementById('searchBtnText');
        const searchSpinner = document.getElementById('searchSpinner');
        const resultsSection = document.getElementById('resultsSection');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const resultsTableContainer = document.getElementById('resultsTableContainer');

        function showLoading() {
            searchBtn.disabled = true;
            searchBtnText.classList.add('d-none');
            searchSpinner.classList.remove('d-none');
        }

        function hideLoading() {
            searchBtn.disabled = false;
            searchBtnText.classList.remove('d-none');
            searchSpinner.classList.add('d-none');
        }

        function performSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }

            showLoading();
            resultsSection.classList.add('d-none');
            noResultsMessage.classList.add('d-none');

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
            
            fetch('/Customers/SearchCustomers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(searchTerm)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success && data.customers && data.customers.length > 0) {
                    displayResults(data.customers);
                    resultsSection.classList.remove('d-none');
                    noResultsMessage.classList.add('d-none');
                } else {
                    resultsSection.classList.add('d-none');
                    noResultsMessage.classList.remove('d-none');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Search error:', error);
                alert('An error occurred while searching. Please try again.');
                resultsSection.classList.add('d-none');
                noResultsMessage.classList.add('d-none');
            });
        }

        function displayResults(customers) {
            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-3" style="width: 5%;">#</th>
                                <th style="width: 12%;">Customer No</th>
                                <th style="width: 18%;">Full Name</th>
                                <th style="width: 15%;">Father Name</th>
                                <th style="width: 12%;">CNIC</th>
                                <th style="width: 10%;">Contact No</th>
                                <th style="width: 8%;">Gender</th>
                                <th style="width: 10%;">City</th>
                                <th class="pe-3 text-center" style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            customers.forEach((customer, index) => {
                const genderBadge = customer.gender ? 
                    (customer.gender.toLowerCase() === 'male' ? 
                        '<span class="badge bg-primary">' + customer.gender + '</span>' : 
                        customer.gender.toLowerCase() === 'female' ? 
                        '<span class="badge bg-danger">' + customer.gender + '</span>' : 
                        '<span class="badge bg-secondary">' + customer.gender + '</span>') : 
                    '<span class="text-muted">-</span>';

                tableHTML += `
                    <tr>
                        <td class="ps-3">${index + 1}</td>
                        <td class="fw-medium">${escapeHtml(customer.customerNo || '')}</td>
                        <td>${escapeHtml(customer.fullName || '')}</td>
                        <td>${escapeHtml(customer.fatherName || '')}</td>
                        <td>${escapeHtml(customer.cnic || '')}</td>
                        <td>${escapeHtml(customer.contactNo || '-')}</td>
                        <td class="text-center">${genderBadge}</td>
                        <td>${escapeHtml(customer.presCity || '-')}</td>
                        <td class="pe-3 text-center">
                            <div class="btn-group" role="group">
                                <a href="/Customers/CustomersDetails/${encodeURIComponent(customer.customerNo)}?returnUrl=CustomersOperation" class="btn btn-sm btn-info" title="View Details">Details</a>
                                <a href="/Customers/CustomersEdit/${encodeURIComponent(customer.customerNo)}?returnUrl=CustomersOperation" class="btn btn-sm btn-warning" title="Edit">Edit</a>
                                <a href="/Customers/Delete/${encodeURIComponent(customer.customerNo)}" class="btn btn-sm btn-danger" title="Delete">Delete</a>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsTableContainer.innerHTML = tableHTML;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        searchBtn.addEventListener('click', performSearch);
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });

        // Clear results when search input is cleared
        searchInput.addEventListener('input', function() {
            if (this.value.trim() === '') {
                resultsSection.classList.add('d-none');
                noResultsMessage.classList.add('d-none');
            }
        });
    })();
</script>

@section Styles {
    <style>
        .container-fluid {
            font-size: 0.875rem;
        }
        .container-fluid h2 {
            font-size: 1.5rem;
        }
        .table {
            font-size: 0.875rem;
        }
        .table th {
            font-size: 0.875rem;
        }
        .table td {
            font-size: 0.875rem;
        }
        .form-label {
            font-size: 0.875rem;
        }
        .btn {
            font-size: 0.875rem;
        }
        .input-group .form-control {
            border-radius: 0.375rem 0 0 0.375rem;
        }
        .input-group .btn {
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
            font-weight: 500;
        }
    </style>
}
