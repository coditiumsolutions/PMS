@model PMS.Web.ViewModels.CustomerAnalyticsViewModel
@{
    ViewData["Title"] = "Customer Analytics";
    var filterOptions = ViewBag.FilterOptions as Dictionary<string, List<string>> ?? new Dictionary<string, List<string>>();
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Customer Analytics & Insights</h2>
        <div>
            <button type="button" class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="bi bi-funnel"></i> Apply Filters
            </button>
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm border-0 h-100 kpi-bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="kpi-label mb-1">Total Customers</h6>
                            <h3 class="mb-0 text-white">@Model.KPIs.TotalCustomers</h3>
                        </div>
                        <div class="text-white" style="font-size: 2.5rem;">üë•</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm border-0 h-100 kpi-bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="kpi-label mb-1">New This Month</h6>
                            <h3 class="mb-0 text-white">@Model.KPIs.NewThisMonth</h3>
                            <small class="kpi-subtext">@(Model.GrowthAnalysis.GrowthRateThisMonth.ToString("F1"))% growth</small>
                        </div>
                        <div class="text-white" style="font-size: 2.5rem;">üìà</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm border-0 h-100 kpi-bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="kpi-label mb-1">Active Cities</h6>
                            <h3 class="mb-0 text-white">@Model.KPIs.ActiveCities</h3>
                            <small class="kpi-subtext">@Model.KPIs.ActiveCountries countries</small>
                        </div>
                        <div class="text-white" style="font-size: 2.5rem;">üåç</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm border-0 h-100 kpi-bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="kpi-label mb-1">Data Quality</h6>
                            <h3 class="mb-0 text-white">@(Model.DataQuality.DataCompletenessPercentage.ToString("F1"))%</h3>
                            <small class="kpi-subtext">Completeness</small>
                        </div>
                        <div class="text-white" style="font-size: 2.5rem;">‚úÖ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Analysis -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Daily Registrations (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyRegistrationsChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Registrations by Creator</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Created By</th>
                                    <th class="text-end">Count</th>
                                    <th class="text-end">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.RegistrationAnalysis.CreatedByAnalysis)
                                {
                                    <tr>
                                        <td>@item.CreatedBy</td>
                                        <td class="text-end">@item.Count</td>
                                        <td class="text-end">@(item.Percentage.ToString("F1"))%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Tables -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Top Cities Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>City</th>
                                    <th class="text-end">Customers</th>
                                    <th class="text-end">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var city in Model.LocationAnalysis.TopCities)
                                {
                                    <tr>
                                        <td>@city.City</td>
                                        <td class="text-end">@city.CustomerCount</td>
                                        <td class="text-end">@(city.Percentage.ToString("F1"))%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Date Range Registrations</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Period</th>
                                    <th class="text-end">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var range in Model.RegistrationAnalysis.DateRangeRegistrations)
                                {
                                    <tr>
                                        <td>@range.RangeLabel</td>
                                        <td class="text-end">@range.Count</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Apply Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" name="startDate">
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" name="endDate">
                    </div>
                    <div class="mb-3">
                        <label for="cityFilter" class="form-label">City</label>
                        <select class="form-select" id="cityFilter" name="city">
                            <option value="">All Cities</option>
                            @foreach (var city in filterOptions.GetValueOrDefault("Cities", new List<string>()))
                            {
                                <option value="@city">@city</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="countryFilter" class="form-label">Country</label>
                        <select class="form-select" id="countryFilter" name="country">
                            <option value="">All Countries</option>
                            @foreach (var country in filterOptions.GetValueOrDefault("Countries", new List<string>()))
                            {
                                <option value="@country">@country</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="genderFilter" class="form-label">Gender</label>
                        <select class="form-select" id="genderFilter" name="gender">
                            <option value="">All Genders</option>
                            @foreach (var gender in filterOptions.GetValueOrDefault("Genders", new List<string>()))
                            {
                                <option value="@gender">@gender</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createdByFilter" class="form-label">Created By</label>
                        <select class="form-select" id="createdByFilter" name="createdBy">
                            <option value="">All Users</option>
                            @foreach (var user in filterOptions.GetValueOrDefault("CreatedBy", new List<string>()))
                            {
                                <option value="@user">@user</option>
                            }
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">Clear All</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Chart data from server
        const dailyRegistrationsData = {
            labels: @Html.Raw(Json.Serialize(Model.RegistrationAnalysis.DailyRegistrations.Select(d => d.DateLabel))),
            data: @Html.Raw(Json.Serialize(Model.RegistrationAnalysis.DailyRegistrations.Select(d => d.Count)))
        };

        // Initialize Charts
        let dailyRegistrationsChart;

        function initCharts() {
            // Daily Registrations Chart
            const dailyCtx = document.getElementById('dailyRegistrationsChart');
            if (dailyCtx) {
                dailyRegistrationsChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyRegistrationsData.labels,
                        datasets: [{
                            label: 'Registrations',
                            data: dailyRegistrationsData.data,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // Filter functions
        function applyFilters() {
            const filter = {
                startDate: document.getElementById('startDate').value || null,
                endDate: document.getElementById('endDate').value || null,
                city: document.getElementById('cityFilter').value || null,
                country: document.getElementById('countryFilter').value || null,
                gender: document.getElementById('genderFilter').value || null,
                createdBy: document.getElementById('createdByFilter').value || null
            };

            // Convert date strings to Date objects if present
            if (filter.startDate) {
                filter.startDate = new Date(filter.startDate).toISOString();
            }
            if (filter.endDate) {
                filter.endDate = new Date(filter.endDate).toISOString();
            }

            // Show loading
            const loadingToast = document.createElement('div');
            loadingToast.className = 'position-fixed top-0 end-0 p-3';
            loadingToast.innerHTML = '<div class="toast show" role="alert"><div class="toast-body">Loading analytics...</div></div>';
            document.body.appendChild(loadingToast);

            fetch('/Customers/GetFilteredAnalytics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filter)
            })
            .then(response => response.json())
            .then(data => {
                // Update page with new data
                updateAnalytics(data);
                document.body.removeChild(loadingToast);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                document.body.removeChild(loadingToast);
                alert('Error loading filtered analytics. Please try again.');
            });
        }

        function clearFilters() {
            document.getElementById('filterForm').reset();
            applyFilters(); // Reload with no filters
        }

        function updateAnalytics(data) {
            // Update KPIs
            document.querySelector('.card:has(h3.text-primary)').querySelector('h3').textContent = data.kPIs.totalCustomers;
            document.querySelector('.card:has(h3.text-success)').querySelector('h3').textContent = data.kPIs.newThisMonth;
            // ... update other KPIs as needed

            // Update other charts similarly...
            // For simplicity, you might want to reload the page instead
            window.location.reload();
        }

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
        });
    </script>
}

@section Styles {
    <style>
        .kpi-bg-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #6ea8fe 100%);
        }
        .kpi-bg-success {
            background: linear-gradient(135deg, #198754 0%, #34d399 100%);
        }
        .kpi-bg-info {
            background: linear-gradient(135deg, #0dcaf0 0%, #7dd3fc 100%);
        }
        .kpi-bg-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        .kpi-label {
            color: rgba(255, 255, 255, 0.85);
        }
        .kpi-subtext {
            color: rgba(255, 255, 255, 0.75);
        }
    </style>
}
