@model PMS.Web.ViewModels.CustomerCreateViewModel

@{
    ViewData["Title"] = "New Customer";
}

<div class="container-fluid">

    <form asp-action="Create" id="customer-create-form" enctype="multipart/form-data">

        @if (!ViewData.ModelState.IsValid)
        {
            <div asp-validation-summary="All" class="alert alert-danger py-2 mb-3" role="alert" id="validationSummary">
                <strong>Please fix the following errors:</strong>
            </div>
        }

        @if (ViewBag.FromRegistration == true)
        {
            <div class="alert alert-info py-2 mb-3">
                <i class="bi bi-info-circle me-1"></i>
                Creating customer from Registration #@ViewBag.RegistrationID. Some fields have been pre-filled.
            </div>
        }

        <input type="hidden" asp-for="Customer.RegistrationID" />

        @* ── Wizard Progress Steps ───────────────────────────────────── *@
        <div class="wizard-progress mb-3">
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-number">1</div>
                    <div class="wizard-step-label">Personal Info</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-number">2</div>
                    <div class="wizard-step-label">Contact Info</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-number">3</div>
                    <div class="wizard-step-label">Requested Property</div>
                </div>
            </div>
        </div>

        @* Hidden nav tabs (controlled by wizard JS) *@
        <ul class="nav nav-tabs mb-3 d-none" id="customerCreateTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal"
                        type="button" role="tab" aria-controls="personal" aria-selected="true">Personal Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact"
                        type="button" role="tab" aria-controls="contact" aria-selected="false">Contact Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="requested-tab" data-bs-toggle="tab" data-bs-target="#requested"
                        type="button" role="tab" aria-controls="requested" aria-selected="false">Requested Property</button>
            </li>
        </ul>

        <div class="tab-content" id="customerCreateTabsContent">

            @* ════════════════════════════════════════════════════════════
               TAB 1 — Personal Info
               ════════════════════════════════════════════════════════════ *@
            <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-person me-2"></i>Personal Information</h6>
                    </div>
                    <div class="card-body py-3">

                        <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1">Basic Details</div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.CreationDate" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.CreationDate" type="date" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.CreationDate" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.FullName" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.FullName" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.FullName" class="text-danger small"></span>
                            </div>
                            <label asp-for="Customer.FatherName" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.FatherName" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.FatherName" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.Cnic" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.Cnic" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.Cnic" class="text-danger small"></span>
                            </div>
                            <label asp-for="Customer.Gender" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <select asp-for="Customer.Gender" class="form-select form-select-sm">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                                <span asp-validation-for="Customer.Gender" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.PlanNo" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <select asp-for="Customer.PlanNo" class="form-select form-select-sm">
                                    <option value="">Select Plan</option>
                                    @foreach (var plan in (ViewBag.PlanOptions as IEnumerable<string>) ?? Array.Empty<string>())
                                    {
                                        <option value="@plan">@plan</option>
                                    }
                                </select>
                            </div>
                            <label asp-for="Customer.DealerID" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <select asp-for="Customer.DealerID" class="form-select form-select-sm">
                                    <option value="">Select Dealer</option>
                                    @foreach (var d in (ViewBag.DealerOptions as IEnumerable<PMS.Web.Models.Dealer>) ?? Array.Empty<PMS.Web.Models.Dealer>())
                                    {
                                        <option value="@d.DealerID">@d.DealershipName</option>
                                    }
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            @* ════════════════════════════════════════════════════════════
               TAB 2 — Contact Info
               ════════════════════════════════════════════════════════════ *@
            <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-telephone me-2"></i>Contact Information</h6>
                    </div>
                    <div class="card-body py-3">

                        <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1">Contact Details</div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.ContactNo" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.ContactNo" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.ContactNo" class="text-danger small"></span>
                            </div>
                            <label asp-for="Customer.Email" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.Email" type="email" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.Email" class="text-danger small"></span>
                            </div>
                        </div>

                        @* Present Address *@
                        <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1 mt-3">Present Address</div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.PresAddress" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-10">
                                <textarea asp-for="Customer.PresAddress" class="form-control form-control-sm" rows="2"></textarea>
                                <span asp-validation-for="Customer.PresAddress" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.PresCity" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.PresCity" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.PresCity" class="text-danger small"></span>
                            </div>
                            <label asp-for="Customer.PresCountry" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.PresCountry" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.PresCountry" class="text-danger small"></span>
                            </div>
                        </div>

                        @* Permanent Address *@
                        <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1 mt-3">Permanent Address</div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.PremAddress" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-10">
                                <textarea asp-for="Customer.PremAddress" class="form-control form-control-sm" rows="2"></textarea>
                                <span asp-validation-for="Customer.PremAddress" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.PremCity" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.PremCity" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.PremCity" class="text-danger small"></span>
                            </div>
                            <label asp-for="Customer.PremCountry" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.PremCountry" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.PremCountry" class="text-danger small"></span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            @* ════════════════════════════════════════════════════════════
               TAB 3 — Requested Property
               ════════════════════════════════════════════════════════════ *@
            <div class="tab-pane fade" id="requested" role="tabpanel" aria-labelledby="requested-tab">

                <div class="card mb-3">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-house me-2"></i>Requested Property</h6>
                    </div>
                    <div class="card-body py-3">

                        <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1">Property Details</div>

                        @{
                            var projectOptions = ViewBag.ProjectOptions as List<PMS.Web.Models.Project> ?? new List<PMS.Web.Models.Project>();
                            var sizeOptions    = ViewBag.SizeOptions as List<string> ?? new List<string>();
                            var categoryOptions = ViewBag.CategoryOptions as List<string> ?? new List<string>();
                        }

                        <div class="row align-items-start mb-2">
                            <label asp-for="RequestedProperty.ReqProject" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <select asp-for="RequestedProperty.ReqProject" id="ReqProject" class="form-select form-select-sm">
                                    <option value="">Select Project</option>
                                    @foreach (var project in projectOptions)
                                    {
                                        if (Model.RequestedProperty?.ReqProject == project.ProjectName)
                                        {
                                            <option value="@project.ProjectName" data-prefix="@project.Prefix" selected>@project.ProjectName</option>
                                        }
                                        else
                                        {
                                            <option value="@project.ProjectName" data-prefix="@project.Prefix">@project.ProjectName</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="RequestedProperty.ReqProject" class="text-danger small"></span>
                            </div>
                            <label asp-for="Customer.CustomerNo" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.CustomerNo" id="Customer_CustomerNo"
                                       class="form-control form-control-sm"
                                       style="background-color:#e9ecef;cursor:not-allowed;"
                                       placeholder="@(string.IsNullOrWhiteSpace(Model.Customer.CustomerNo) ? "Select a project to generate" : "")" />
                                <small class="text-muted">Auto-generated based on selected project</small>
                                <span asp-validation-for="Customer.CustomerNo" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="RequestedProperty.ReqSize" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <select asp-for="RequestedProperty.ReqSize" class="form-select form-select-sm">
                                    <option value="">Select Size</option>
                                    @foreach (var size in sizeOptions)
                                    {
                                        <option value="@size">@size</option>
                                    }
                                </select>
                                <span asp-validation-for="RequestedProperty.ReqSize" class="text-danger small"></span>
                            </div>
                            <label asp-for="RequestedProperty.ReqCategory" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <select asp-for="RequestedProperty.ReqCategory" class="form-select form-select-sm">
                                    <option value="">Select Category</option>
                                    @foreach (var category in categoryOptions)
                                    {
                                        <option value="@category">@category</option>
                                    }
                                </select>
                                <span asp-validation-for="RequestedProperty.ReqCategory" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row align-items-start mb-2">
                            <label asp-for="RequestedProperty.ReqConstruction" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="RequestedProperty.ReqConstruction" class="form-control form-control-sm" />
                                <span asp-validation-for="RequestedProperty.ReqConstruction" class="text-danger small"></span>
                            </div>
                        </div>

                        @* Documents *@
                        <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1 mt-3">Documents</div>

                        <div class="row align-items-start mb-2">
                            <label class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end">Customer Image</label>
                            <div class="col-md-4">
                                <input type="file" name="customerImage" class="form-control form-control-sm" accept="image/*" />
                                @if (!string.IsNullOrEmpty(Model.Customer.CustomerImage))
                                {
                                    <small class="text-muted">Current: @Model.Customer.CustomerImage</small>
                                }
                            </div>
                            <label class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end">Attachments</label>
                            <div class="col-md-4">
                                <input type="file" name="attachmentFiles" class="form-control form-control-sm" multiple />
                                <small class="text-muted">Multiple files allowed</small>
                            </div>
                        </div>

                    </div>
                </div>

                @* Additional Info *@
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Additional Information</h6>
                    </div>
                    <div class="card-body py-3">
                        <div class="row align-items-start mb-2">
                            <label asp-for="Customer.CreatedBy" class="col-md-2 col-form-label col-form-label-sm fw-semibold text-end"></label>
                            <div class="col-md-4">
                                <input asp-for="Customer.CreatedBy" class="form-control form-control-sm" />
                                <span asp-validation-for="Customer.CreatedBy" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        @* ── Wizard Navigation Buttons ───────────────────────────────── *@
        <div class="card shadow-sm mt-3">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)" style="display:none;">
                        <i class="bi bi-arrow-left me-1"></i>Previous
                    </button>
                    <div class="ms-auto">
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                            Next <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">
                            <i class="bi bi-check-circle me-1"></i>Create Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>

@section Styles {
    <style>
        .wizard-progress { padding: 16px 0; }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .wizard-step-number {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 6px;
            transition: all 0.3s ease;
            border: 3px solid #e9ecef;
        }

        .wizard-step.active .wizard-step-number {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .wizard-step.completed .wizard-step-number {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }

        .wizard-step.completed .wizard-step-number::before {
            content: "✓";
            font-size: 1.3rem;
        }

        .wizard-step-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
            text-align: center;
        }

        .wizard-step.active .wizard-step-label  { color: #0d6efd; font-weight: 600; }
        .wizard-step.completed .wizard-step-label { color: #198754; }

        .wizard-step-line {
            flex: 1;
            height: 3px;
            background-color: #e9ecef;
            margin: 0 8px;
            margin-top: -32px;
            transition: background-color 0.3s ease;
        }

        .wizard-step.completed + .wizard-step-line { background-color: #198754; }

        .tab-pane          { display: none; }
        .tab-pane.active   { display: block; }

        @@media (max-width: 768px) {
            .wizard-step-label  { font-size: 0.75rem; }
            .wizard-step-number { width: 36px; height: 36px; font-size: 0.95rem; }
        }
    </style>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let currentStep = 1;
        const totalSteps = 3;

        function showStep(step) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });

            const panes = ['personal', 'contact', 'requested'];
            const currentPane = document.getElementById(panes[step - 1]);
            if (currentPane) currentPane.classList.add('show', 'active');

            document.querySelectorAll('.wizard-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                stepEl.classList.remove('active', 'completed');
                if (stepNum < step)       stepEl.classList.add('completed');
                else if (stepNum === step) stepEl.classList.add('active');
            });

            const prevBtn   = document.getElementById('prevBtn');
            const nextBtn   = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.style.display   = step === 1 ? 'none' : 'inline-block';
            nextBtn.style.display   = step === totalSteps ? 'none' : 'inline-block';
            submitBtn.style.display = step === totalSteps ? 'inline-block' : 'none';
        }

        function validateStep(step) {
            if (step === 1) {
                const fullName   = document.getElementById('Customer_FullName');
                const fatherName = document.getElementById('Customer_FatherName');
                const cnic       = document.getElementById('Customer_Cnic');

                if (!fullName?.value.trim())   { alert('Please enter Full Name');   fullName?.focus();   return false; }
                if (!fatherName?.value.trim()) { alert('Please enter Father Name'); fatherName?.focus(); return false; }
                if (!cnic?.value.trim())       { alert('Please enter CNIC');        cnic?.focus();       return false; }
            }
            return true;
        }

        function changeStep(direction) {
            const newStep = currentStep + direction;
            if (direction > 0 && !validateStep(currentStep)) return;
            if (newStep >= 1 && newStep <= totalSteps) {
                currentStep = newStep;
                showStep(currentStep);
            }
        }

        async function generateCustomerNo(projectName) {
            const customerNoInput = document.getElementById('Customer_CustomerNo');
            if (!customerNoInput) return Promise.reject('Field not found');

            if (!projectName) {
                customerNoInput.value = '';
                customerNoInput.placeholder = 'Select a project to generate';
                return Promise.resolve('');
            }

            customerNoInput.value = 'Generating...';
            customerNoInput.disabled = true;

            try {
                const response = await fetch(`/Customers/GetNextCustomerNo?projectName=${encodeURIComponent(projectName)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.customerNo) {
                    customerNoInput.value = data.customerNo;
                    customerNoInput.placeholder = '';
                    return Promise.resolve(data.customerNo);
                } else {
                    customerNoInput.value = '';
                    customerNoInput.placeholder = 'Unable to generate. Check project prefix.';
                    return Promise.reject('No customerNo in response');
                }
            } catch (error) {
                console.error('Error generating Customer No:', error);
                customerNoInput.value = '';
                customerNoInput.placeholder = 'Error generating Customer No';
                return Promise.reject(error);
            } finally {
                customerNoInput.disabled = false;
            }
        }

        (function () {
            const projectSelect   = document.getElementById('ReqProject');
            const customerNoInput = document.getElementById('Customer_CustomerNo');

            if (projectSelect && customerNoInput) {
                projectSelect.addEventListener('change', async function () {
                    await generateCustomerNo(this.value);
                });

                const selectedProject = projectSelect.value;
                if (selectedProject && !customerNoInput.value) {
                    setTimeout(() => generateCustomerNo(selectedProject), 100);
                }
            }
        })();

        (function () {
            showStep(1);

            const validationSummary = document.getElementById('validationSummary');
            if (validationSummary) {
                validationSummary.style.display = 'block';
                const errorText = validationSummary.textContent.toLowerCase();
                if (errorText.includes('customer no') || errorText.includes('project')) {
                    showStep(3);
                } else if (errorText.includes('full name') || errorText.includes('father name') || errorText.includes('cnic')) {
                    showStep(1);
                } else if (errorText.includes('contact') || errorText.includes('email') || errorText.includes('address')) {
                    showStep(2);
                }
            }

            const form = document.getElementById('customer-create-form');
            if (!form) return;

            form.addEventListener('submit', function (e) {
                const fullName     = document.getElementById('Customer_FullName');
                const fatherName   = document.getElementById('Customer_FatherName');
                const cnic         = document.getElementById('Customer_Cnic');
                const customerNo   = document.getElementById('Customer_CustomerNo');
                const creationDate = document.getElementById('Customer_CreationDate');
                const projectSelect = document.getElementById('ReqProject');

                if (customerNo && (!customerNo.value?.trim()) && projectSelect?.value) {
                    e.preventDefault();
                    generateCustomerNo(projectSelect.value).then(generatedNo => {
                        if (generatedNo && customerNo) {
                            customerNo.value = generatedNo;
                            form.submit();
                        } else {
                            alert('Error generating Customer No. Please try selecting the project again.');
                        }
                    }).catch(() => {
                        alert('Error generating Customer No. Please try selecting the project again.');
                    });
                    return;
                }

                const missing    = [];
                const missingTabs = [];

                if (!fullName?.value.trim())     { missing.push('Full Name');     missingTabs.push(1); }
                if (!fatherName?.value.trim())   { missing.push('Father Name');   missingTabs.push(1); }
                if (!cnic?.value.trim())         { missing.push('CNIC');          missingTabs.push(1); }
                if (!creationDate?.value.trim()) { missing.push('Creation Date'); missingTabs.push(1); }

                if (!customerNo?.value?.trim() && !projectSelect?.value) {
                    missing.push('Customer No (select a project in Requested Property tab)');
                    missingTabs.push(3);
                }

                if (missing.length > 0) {
                    e.preventDefault();
                    const tabNames = { 1: 'Personal Info', 2: 'Contact Info', 3: 'Requested Property' };
                    const errorTabs = [...new Set(missingTabs)].map(t => tabNames[t]).join(', ');
                    alert('Please fill the following required fields before saving:\n\n' +
                          missing.join('\n') +
                          '\n\nPlease check the ' + errorTabs + ' tab(s).');

                    if (missingTabs.includes(3))      showStep(3);
                    else if (missingTabs.includes(1)) showStep(1);
                    else                              showStep(2);
                }
            });
        })();
    </script>

    @if (TempData["SuccessMessage"] is string successMessage)
    {
        <script>alert('@successMessage');</script>
    }
}
