@model IEnumerable<PMS.Web.Models.CustomerAuditLog>

@{
    ViewData["Title"] = "Customer Audit History";
    string? currentSearch = ViewBag.CustomerId as string;
}

<div class="container-fluid">

    @* ── Search ───────────────────────────────────────────────────────── *@
    <form method="get" asp-action="History" class="mb-3">
        <div class="input-group" style="max-width:380px;">
            <span class="input-group-text bg-white">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text"
                   name="customerId"
                   class="form-control"
                   placeholder="Enter Customer No…"
                   value="@currentSearch" />
            <button type="submit" class="btn btn-primary">Search</button>
            @if (!string.IsNullOrEmpty(currentSearch))
            {
                <a asp-action="History" class="btn btn-outline-secondary">Clear</a>
            }
        </div>
        @if (!string.IsNullOrEmpty(currentSearch))
        {
            <small class="text-muted mt-1 d-block">
                Showing results for: <strong>@currentSearch</strong>
                &nbsp;·&nbsp; @Model?.Count() record(s) found
            </small>
        }
    </form>

    @* ── Grid ─────────────────────────────────────────────────────────── *@
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0" id="historyTable">
                    <thead style="background-color:#071a2e; color:white;">
                        <tr>
                            <th style="width:50px;">#</th>
                            <th>Customer No</th>
                            <th>Action</th>
                            <th>Changed Fields</th>
                            <th>Action By</th>
                            <th>Date &amp; Time</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            int i = 1;
                            foreach (var log in Model)
                            {
                                <tr class="history-row"
                                    data-modal-target="historyModal_@log.LogID"
                                    title="Double-click to view record">
                                    <td>@i</td>
                                    <td class="fw-medium">@log.CustomerID</td>
                                    <td>@log.ActionType</td>
                                    <td>@log.ChangedFields</td>
                                    <td>@log.ActionBy</td>
                                    <td>@log.ActionDate.ToString("dd MMM yyyy HH:mm:ss")</td>
                                    <td>@log.Remarks</td>
                                </tr>
                                i++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    No records found@(!string.IsNullOrEmpty(currentSearch) ? $" for \"{currentSearch}\"" : "").
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @* ── Per-row detail modals ─────────────────────────────────────────── *@
    @if (Model != null)
    {
        foreach (var log in Model)
        {
            Dictionary<string, System.Text.Json.JsonElement>? oldDict = null;
            Dictionary<string, System.Text.Json.JsonElement>? newDict = null;
            try
            {
                if (!string.IsNullOrEmpty(log.OldValues))
                    oldDict = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, System.Text.Json.JsonElement>>(log.OldValues);
                if (!string.IsNullOrEmpty(log.NewValues))
                    newDict = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, System.Text.Json.JsonElement>>(log.NewValues);
            }
            catch { }

            <div class="modal fade" id="historyModal_@log.LogID" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
                    <div class="modal-content">

                        @* Header *@
                        <div class="modal-header py-2 @(log.ActionType == "DELETE" ? "bg-danger text-white" : "bg-warning text-dark")">
                            <h6 class="modal-title mb-0">
                                <i class="bi @(log.ActionType == "DELETE" ? "bi-trash" : "bi-pencil") me-2"></i>
                                History Record — @log.CustomerID
                            </h6>
                            <button type="button"
                                    class="btn-close @(log.ActionType == "DELETE" ? "btn-close-white" : "")"
                                    data-bs-dismiss="modal"></button>
                        </div>

                        @* Body *@
                        <div class="modal-body p-0">

                            @* Summary strip *@
                            <table class="table table-sm table-bordered mb-0 border-bottom">
                                <tbody>
                                    <tr>
                                        <td class="fw-semibold text-muted ps-3" style="width:35%">Log ID</td>
                                        <td>@log.LogID</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold text-muted ps-3">Customer No</td>
                                        <td class="fw-medium">@log.CustomerID</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold text-muted ps-3">Action Type</td>
                                        <td>
                                            @if (log.ActionType == "UPDATE")
                                            {
                                                <span class="badge bg-warning text-dark">UPDATE</span>
                                            }
                                            else if (log.ActionType == "DELETE")
                                            {
                                                <span class="badge bg-danger">DELETE</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@log.ActionType</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold text-muted ps-3">Changed Fields</td>
                                        <td>@(log.ChangedFields ?? "—")</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold text-muted ps-3">Action By</td>
                                        <td>@(log.ActionBy ?? "—")</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold text-muted ps-3">Action Date</td>
                                        <td>@log.ActionDate.ToString("dd MMM yyyy, HH:mm:ss")</td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(log.Remarks))
                                    {
                                        <tr>
                                            <td class="fw-semibold text-muted ps-3">Remarks</td>
                                            <td>@log.Remarks</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            @* UPDATE — Before / After diff *@
                            @if (log.ActionType == "UPDATE" && oldDict != null && newDict != null && oldDict.Count > 0)
                            {
                                <div class="px-3 pt-2 pb-1">
                                    <small class="text-uppercase text-muted fw-semibold">Field Changes</small>
                                </div>
                                <table class="table table-sm table-bordered mb-0">
                                    <thead style="background-color:#071a2e; color:white;">
                                        <tr>
                                            <th class="ps-3" style="width:34%">Field</th>
                                            <th style="width:33%">Before</th>
                                            <th style="width:33%">After</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var kv in oldDict)
                                        {
                                            var before = kv.Value.ValueKind == System.Text.Json.JsonValueKind.Null ? "—" : kv.Value.ToString();
                                            var after  = newDict.TryGetValue(kv.Key, out var nv)
                                                ? (nv.ValueKind == System.Text.Json.JsonValueKind.Null ? "—" : nv.ToString())
                                                : "—";
                                            bool changed = before != after;
                                            <tr class="@(changed ? "table-warning" : "")">
                                                <td class="fw-semibold text-muted ps-3">@kv.Key</td>
                                                <td class="@(changed ? "text-danger" : "text-muted")">@before</td>
                                                <td class="@(changed ? "text-success fw-semibold" : "text-muted")">@after</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }

                            @* DELETE — full snapshot *@
                            else if (log.ActionType == "DELETE" && oldDict != null)
                            {
                                <div class="px-3 pt-2 pb-1">
                                    <small class="text-uppercase text-muted fw-semibold">
                                        <i class="bi bi-exclamation-triangle text-danger me-1"></i>
                                        Record Snapshot at Deletion
                                    </small>
                                </div>
                                <table class="table table-sm table-bordered mb-0">
                                    <thead style="background-color:#071a2e; color:white;">
                                        <tr>
                                            <th class="ps-3" style="width:40%">Field</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var kv in oldDict)
                                        {
                                            <tr>
                                                <td class="fw-semibold text-muted ps-3">@kv.Key</td>
                                                <td>@(kv.Value.ValueKind == System.Text.Json.JsonValueKind.Null ? "—" : kv.Value.ToString())</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }

                        </div>

                        @* Footer — close only, no action buttons *@
                        <div class="modal-footer py-2">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i>Close
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        }
    }

</div>

<script>
    document.querySelectorAll('#historyTable .history-row').forEach(function (row) {
        row.addEventListener('dblclick', function () {
            var modalId = this.getAttribute('data-modal-target');
            if (modalId) {
                var el = document.getElementById(modalId);
                if (el) bootstrap.Modal.getOrCreateInstance(el).show();
            }
        });
    });
</script>

<style>
    #historyTable thead th {
        font-size: 0.8rem;
        padding: 0.5rem;
        white-space: nowrap;
    }
    #historyTable tbody td {
        font-size: 0.82rem;
        vertical-align: middle;
        padding: 0.4rem 0.5rem;
    }
    #historyTable .history-row {
        cursor: pointer;
    }
    #historyTable .history-row:hover {
        background-color: #cfe2ff !important;
    }
    .modal .table td, .modal .table th {
        font-size: 0.82rem;
        padding: 0.35rem 0.5rem;
        vertical-align: middle;
    }
</style>
