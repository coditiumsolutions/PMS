@model PMS.Web.Models.Customer

@{
    ViewData["Title"] = "Customer Details";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Customer Details</h2>
        <div class="d-flex gap-2">
            <a asp-action="History" asp-route-customerId="@Model.CustomerNo" class="btn btn-info btn-sm">
                <i class="bi bi-clock-history me-1"></i>History
            </a>
            <a asp-action="@(ViewBag.UseCustomersDetails == true ? "CustomersEdit" : "Edit")"
               asp-route-id="@Model.CustomerNo"
               asp-route-returnUrl="@ViewBag.ReturnUrl"
               class="btn btn-warning btn-sm">
                <i class="bi bi-pencil me-1"></i>Edit
            </a>
            <a asp-action="Delete" asp-route-id="@Model.CustomerNo" class="btn btn-danger btn-sm">
                <i class="bi bi-trash me-1"></i>Delete
            </a>
            @if (!string.IsNullOrEmpty(ViewBag.ReturnUrl as string) && ViewBag.ReturnUrl == "CustomersOperation")
            {
                <a asp-action="CustomersOperation" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Operations
                </a>
            }
            else
            {
                <a asp-action="@(ViewBag.UseCustomersDetails == true ? "CustomersDetail" : "Index")" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
            }
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white py-2">
            <h6 class="mb-0"><i class="bi bi-person-vcard me-2"></i>@Model.CustomerNo — @Model.FullName</h6>
        </div>
        <div class="card-body py-3">

            @* ── Tabs ──────────────────────────────────────────────────── *@
            <ul class="nav nav-tabs mb-3" id="customerDetailsTabs" role="tablist">
                <li class="nav-item me-1" role="presentation">
                    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab"
                            data-bs-target="#personal" type="button" role="tab"
                            aria-controls="personal" aria-selected="true">
                        <i class="bi bi-person me-1"></i>Personal Detail
                    </button>
                </li>
                <li class="nav-item me-1" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab"
                            data-bs-target="#contact" type="button" role="tab"
                            aria-controls="contact" aria-selected="false">
                        <i class="bi bi-telephone me-1"></i>Contact Detail
                    </button>
                </li>
                <li class="nav-item me-1" role="presentation">
                    <button class="nav-link" id="allotment-tab" data-bs-toggle="tab"
                            data-bs-target="#allotment" type="button" role="tab"
                            aria-controls="allotment" aria-selected="false">
                        <i class="bi bi-house me-1"></i>Allotment Detail
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="customerDetailsTabContent">

                @* ════════════════════════════════════════════════════════
                   TAB 1 — Personal Detail
                   ════════════════════════════════════════════════════════ *@
                <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">

                    <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1">Basic Details</div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Customer No</div>
                        <div class="col-md-4">@(Model.CustomerNo ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Creation Date</div>
                        <div class="col-md-4">@Model.CreationDate.ToString("dd MMM yyyy")</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Full Name</div>
                        <div class="col-md-4">@(Model.FullName ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Father Name</div>
                        <div class="col-md-4">@(Model.FatherName ?? "—")</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">CNIC</div>
                        <div class="col-md-4">@(Model.Cnic ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Gender</div>
                        <div class="col-md-4">
                            @if (!string.IsNullOrWhiteSpace(Model.Gender))
                            {
                                <span class="badge @(Model.Gender.ToLower() == "male" ? "bg-primary" : "bg-danger") bg-opacity-75">
                                    @Model.Gender
                                </span>
                            }
                            else { <span>—</span> }
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Plan No</div>
                        <div class="col-md-4">@(Model.PlanNo ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Dealer</div>
                        <div class="col-md-4">@(Model.Dealer?.DealershipName ?? "—")</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Created By</div>
                        <div class="col-md-4">@(Model.CreatedBy ?? "—")</div>
                    </div>

                    @* Documents *@
                    <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1 mt-3">Documents</div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Customer Image</div>
                        <div class="col-md-4">
                            @if (!string.IsNullOrEmpty(Model.CustomerImage))
                            {
                                <img src="@Model.CustomerImage" alt="Customer" class="img-thumbnail" style="max-height:100px;" />
                                <div><small class="text-muted">@System.IO.Path.GetFileName(Model.CustomerImage)</small></div>
                            }
                            else { <span>—</span> }
                        </div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Attachments</div>
                        <div class="col-md-4">
                            @if (!string.IsNullOrEmpty(Model.CustomerAttachment))
                            {
                                try
                                {
                                    var paths = System.Text.Json.JsonSerializer.Deserialize<List<string>>(Model.CustomerAttachment);
                                    if (paths != null && paths.Count > 0)
                                    {
                                        foreach (var p in paths)
                                        {
                                            <a href="@p" target="_blank" class="d-block small">
                                                <i class="bi bi-paperclip me-1"></i>@System.IO.Path.GetFileName(p)
                                            </a>
                                        }
                                    }
                                    else { <span>—</span> }
                                }
                                catch { <span>@Model.CustomerAttachment</span> }
                            }
                            else { <span>—</span> }
                        </div>
                    </div>

                </div>

                @* ════════════════════════════════════════════════════════
                   TAB 2 — Contact Detail
                   ════════════════════════════════════════════════════════ *@
                <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">

                    <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1">Contact Details</div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Contact No</div>
                        <div class="col-md-4">@(Model.ContactNo ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Email</div>
                        <div class="col-md-4">
                            @if (!string.IsNullOrWhiteSpace(Model.Email))
                            {
                                <a href="mailto:@Model.Email">@Model.Email</a>
                            }
                            else { <span>—</span> }
                        </div>
                    </div>

                    @* Present Address *@
                    <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1 mt-3">Present Address</div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Address</div>
                        <div class="col-md-10">@(Model.PresAddress ?? "—")</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">City</div>
                        <div class="col-md-4">@(Model.PresCity ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Country</div>
                        <div class="col-md-4">@(Model.PresCountry ?? "—")</div>
                    </div>

                    @* Permanent Address *@
                    <div class="text-uppercase text-muted small fw-semibold mb-2 border-bottom pb-1 mt-3">Permanent Address</div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">Address</div>
                        <div class="col-md-10">@(Model.PremAddress ?? "—")</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-2 fw-semibold text-end text-muted small">City</div>
                        <div class="col-md-4">@(Model.PremCity ?? "—")</div>
                        <div class="col-md-2 fw-semibold text-end text-muted small">Country</div>
                        <div class="col-md-4">@(Model.PremCountry ?? "—")</div>
                    </div>

                </div>

                @* ════════════════════════════════════════════════════════
                   TAB 3 — Allotment Detail
                   ════════════════════════════════════════════════════════ *@
                <div class="tab-pane fade" id="allotment" role="tabpanel" aria-labelledby="allotment-tab">
                    <p class="text-muted mb-0 small">Allotment information is not available yet.</p>
                </div>

            </div>

            @* ── Action Buttons ──────────────────────────────────────── *@
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <a asp-action="History" asp-route-customerId="@Model.CustomerNo" class="btn btn-info px-4">
                        <i class="bi bi-clock-history me-1"></i>History
                    </a>
                    <a asp-action="@(ViewBag.UseCustomersDetails == true ? "CustomersEdit" : "Edit")"
                       asp-route-id="@Model.CustomerNo"
                       asp-route-returnUrl="@ViewBag.ReturnUrl"
                       class="btn btn-warning ms-2 px-4">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                    <a asp-action="Delete" asp-route-id="@Model.CustomerNo" class="btn btn-danger ms-2 px-4">
                        <i class="bi bi-trash me-1"></i>Delete
                    </a>
                    @if (!string.IsNullOrEmpty(ViewBag.ReturnUrl as string) && ViewBag.ReturnUrl == "CustomersOperation")
                    {
                        <a asp-action="CustomersOperation" class="btn btn-secondary ms-2 px-4">
                            <i class="bi bi-arrow-left me-1"></i>Back to Operations
                        </a>
                    }
                    else
                    {
                        <a asp-action="@(ViewBag.UseCustomersDetails == true ? "CustomersDetail" : "Index")" class="btn btn-secondary ms-2 px-4">
                            <i class="bi bi-arrow-left me-1"></i>Back to List
                        </a>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

@section Styles {
    <style>
        .nav-tabs .nav-link {
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        .nav-tabs .nav-link.active {
            font-weight: 600;
            border-bottom: 2px solid var(--bs-primary);
        }
        .nav-tabs .nav-link:not(.active):hover {
            background-color: var(--bs-light);
        }
    </style>
}
